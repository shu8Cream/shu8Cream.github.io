---
// src/pages/blog/[...page].astro
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import { Icon } from 'astro-icon/components';

// 1. ページ分割の設定
export async function getStaticPaths({ paginate }) {
  const allPosts = (await getCollection('blog')).sort(
    // (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
    (a, b) => b.slug.localeCompare(a.slug)
  );
  // pageSizeは適宜調整してください（20推奨）
  return paginate(allPosts, { pageSize: 10 }); 
}

const { page } = Astro.props;

// --- ▼▼▼ ページネーション生成ロジック（前回と同じ） ▼▼▼ ---
const totalPage = page.lastPage;
const current = page.currentPage;
const delta = 2;
const range = [];
const rangeWithDots = [];
let l;

for (let i = 1; i <= totalPage; i++) {
    if (i === 1 || i === totalPage || (i >= current - delta && i <= current + delta)) {
        range.push(i);
    }
}
range.forEach(i => {
    if (l) {
        if (i - l === 2) { rangeWithDots.push(l + 1); }
        else if (i - l !== 1) { rangeWithDots.push('...'); }
    }
    rangeWithDots.push(i);
    l = i;
});
const getPageUrl = (n) => n === 1 ? '/blog' : `/blog/${n}`;

// --- ▼▼▼ 新追加：タグの集計ロジック ▼▼▼ ---
const allPosts = await getCollection('blog');
// 全記事からタグを取り出してカウントする
const tagCounts = allPosts.flatMap(post => post.data.tags).reduce((acc, tag) => {
    acc[tag] = (acc[tag] || 0) + 1;
    return acc;
}, {});
// 記事数が多い順にソート
const sortedTags = Object.keys(tagCounts).sort((a, b) => tagCounts[b] - tagCounts[a]);
---

<Layout title={`Blog (Page ${page.currentPage}) | shu8Cream.dev`} fullWidth={true}>
    <div class="max-w-6xl mx-auto px-4">
        <h1 class="text-4xl font-bold mb-12 bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-blue-400">
            Blog
        </h1>
        
        <div class="flex flex-col lg:flex-row gap-12">
            
            <main class="flex-1 min-w-0">
                <div class="grid gap-6 mb-16">
                    {page.data.map((post) => (
                        <a href={`/blog/${post.slug}`} class="block group">
                            <article class="p-6 rounded-2xl bg-white/5 border border-white/10 backdrop-blur-sm transition duration-300 hover:bg-white/10 hover:border-purple-500/50 hover:shadow-lg hover:shadow-purple-500/10">
                                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-4">
                                    <h2 class="text-2xl font-bold group-hover:text-purple-400 transition">
                                        {post.data.title}
                                    </h2>
                                    <div class="text-sm text-gray-400 flex flex-wrap items-start gap-3 shrink-0">
                                        <div class="flex flex-col gap-1">
                                            <div class="flex items-center gap-1.5" title="公開日">
                                                <Icon name="mdi:calendar-month" class="w-4 h-4 text-gray-500" />
                                                <time class="leading-none">{post.data.pubDate.toLocaleDateString('ja-JP')}</time>
                                            </div>
                                            
                                            {post.data.updatedDate && (
                                                <div class="flex items-center gap-1.5 text-purple-400 text-xs" title="更新日">
                                                    <Icon name="mdi:update" class="w-3.5 h-3.5" />
                                                    <time class="leading-none">{post.data.updatedDate.toLocaleDateString('ja-JP')}</time>
                                                </div>
                                            )}
                                        </div>
                                        
                                        <span class="px-2 py-1 rounded bg-white/5 text-purple-300 border border-white/10 text-xs self-start mt-0.5">
                                            #{post.data.tags[0]}
                                        </span>
                                    </div>
                                </div>
                                <p class="text-gray-300 line-clamp-2">{post.data.description}</p>
                            </article>
                        </a>
                    ))}
                </div>

                <div class="flex justify-center items-center gap-2 flex-wrap">
                    {page.url.prev ? (
                        <a href={page.url.prev} class="w-10 h-10 flex items-center justify-center rounded-lg bg-white/5 border border-white/10 hover:bg-white/20 transition text-white">&lt;</a>
                    ) : (
                        <span class="w-10 h-10 flex items-center justify-center rounded-lg border border-transparent text-gray-600 cursor-not-allowed">&lt;</span>
                    )}
                    {rangeWithDots.map((number) => (
                        number === '...' ? (
                            <span class="text-gray-500 px-2">...</span>
                        ) : (
                            <a href={getPageUrl(number)} class={`w-10 h-10 flex items-center justify-center rounded-lg border transition font-bold ${number === current ? 'bg-purple-600 border-purple-500 text-white shadow-lg shadow-purple-500/30' : 'bg-white/5 border-white/10 text-gray-300 hover:bg-white/20 hover:border-white/30'}`}>{number}</a>
                        )
                    ))}
                    {page.url.next ? (
                        <a href={page.url.next} class="w-10 h-10 flex items-center justify-center rounded-lg bg-white/5 border border-white/10 hover:bg-white/20 transition text-white">&gt;</a>
                    ) : (
                        <span class="w-10 h-10 flex items-center justify-center rounded-lg border border-transparent text-gray-600 cursor-not-allowed">&gt;</span>
                    )}
                </div>
            </main>

            <aside class="w-full lg:w-72 shrink-0">
                <div class="sticky top-24 p-6 rounded-2xl bg-white/5 border border-white/10 backdrop-blur-sm shadow-xl">
                    <h2 class="text-xl font-bold mb-6 flex items-center gap-2 border-b border-white/10 pb-2">
                        <span class="text-purple-400">#</span> Popular Tags
                    </h2>
                    <div class="flex flex-wrap gap-2">
                        {sortedTags.map(tag => (
                            <a href={`/tags/${tag}`} class="group px-3 py-1.5 text-sm rounded-full bg-white/5 border border-white/10 text-gray-300 hover:bg-purple-500/20 hover:border-purple-500/50 hover:text-purple-300 transition flex items-center gap-2">
                                <span>{tag}</span>
                                <span class="text-xs text-gray-500 bg-black/20 px-2 py-0.5 rounded-full group-hover:text-purple-200 transition">
                                    {tagCounts[tag]}
                                </span>
                            </a>
                        ))}
                    </div>
                </div>
            </aside>

        </div>
    </div>
</Layout>