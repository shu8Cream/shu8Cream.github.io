---
// src/pages/tags/[tag].astro
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

// 1. 全てのタグを収集し、ページ生成用のパスを作る
export async function getStaticPaths() {
  const allBlogPosts = await getCollection('blog');
  const allWorks = await getCollection('works');

  // ブログとWorksの全タグを結合して重複を削除
  const uniqueTags = [...new Set([
    ...allBlogPosts.flatMap(post => post.data.tags),
    ...allWorks.flatMap(work => work.data.tags)
  ])];

  // タグごとのページ情報を返す
  return uniqueTags.map(tag => {
    // そのタグを含む記事だけをフィルタリング
    const filteredPosts = allBlogPosts.filter(post => post.data.tags.includes(tag));
    const filteredWorks = allWorks.filter(work => work.data.tags.includes(tag));

    return {
      params: { tag },
      props: { posts: filteredPosts, works: filteredWorks },
    };
  });
}

// 2. ページに渡されたデータを取得
const { tag } = Astro.params;
const { posts, works } = Astro.props;
---

<Layout title={`Tag: ${tag} | shu8Cream.dev`} fullWidth={true}>
  <div class="max-w-4xl mx-auto">
    
    <header class="mb-12 text-center">
      <p class="mb-2" style="color: var(--color-text-muted);">Tag Search</p>
      <h1 class="text-4xl md:text-5xl font-bold">
        <span class="text-purple-400">#</span>{tag}
      </h1>
    </header>

    {works.length > 0 && (
      <section class="mb-16">
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
          <span class="w-2 h-8 bg-blue-500 rounded-full"></span>
          Works
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          {works.map((work) => (
            <a href={`/works/${work.slug}`} class="group block">
              <div class="flex items-center gap-4 p-4 rounded-xl glass-card hover:border-blue-500/50 transition">
                {work.data.image && (
                  <img src={work.data.image} alt={work.data.title} class="w-20 h-20 object-cover rounded-lg bg-gray-800" />
                )}
                <div>
                  <h3 class="font-bold group-hover:text-blue-400 transition">{work.data.title}</h3>
                  <p class="text-sm mt-1" style="color: var(--color-text-muted);">{work.data.pubDate.toISOString().split('T')[0]}</p>
                </div>
              </div>
            </a>
          ))}
        </div>
      </section>
    )}

    {posts.length > 0 && (
      <section>
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
          <span class="w-2 h-8 bg-purple-500 rounded-full"></span>
          Blog Posts
        </h2>
        <div class="grid gap-4">
          {posts.map((post) => (
            <a href={`/blog/${post.slug}`} class="block group">
              <article class="p-6 rounded-xl glass-card hover:border-purple-500/50 transition">
                <h3 class="text-xl font-bold mb-2 group-hover:text-purple-400 transition">
                  {post.data.title}
                </h3>
                <div class="flex gap-4 text-sm" style="color: var(--color-text-muted);">
                  <time>{post.data.pubDate.toISOString().split('T')[0]}</time>
                  <span>{post.data.description}</span>
                </div>
              </article>
            </a>
          ))}
        </div>
      </section>
    )}

    <div class="mt-16 text-center pt-8" style="border-top: 1px solid var(--glass-border);">
      <a href="/" class="hover:text-purple-400 transition" style="color: var(--color-text-muted);">← Topに戻る</a>
    </div>

  </div>
</Layout>